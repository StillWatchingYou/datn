<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đồ Án Tốt Nghiệp</title>
    <link rel="icon" type="image/x-icon"
        href="/./public/assets/image/2210.i511.028.S.m009.c13.gas appliance flat text.jpg">
    <link rel="stylesheet" href="style.css">
    <!-- <script src="script.js"></script> -->
</head>

<body>

    <div>
        <p id="title"> HỆ THỐNG QUẢN LÝ KHÍ GAS TRONG NHÀ </p>
    </div>
    <div class="row">
        <div class="row">
            <div id="CH4-details" class="tex-infor">
                <p style="font-weight: bold; font-size: 32px;">Phòng 1</p>
                <p style="font-weight: bold;">LPG:</p>
                <span style="font-size: 36px;" id="CH4"><br></span>
                <div id="stadard-info">
                    <div id="temp" class="tex-infor">
                        <img style="height: 40px; width: 26.3px;" src="./assets/image/R.png" alt="" srcset="">
                        <p>Nhiệt độ hiện tại: </p>
                        <span id="temp-details" class="formatted-number"></span>
                        <p> độ C</p>
                    </div>
                    <div id="hump" class="tex-infor">
                        <img style="height: 40px; width: 40px;" src="./assets/image/R.jpg" alt="" srcset="">
                        <p>Độ ẩm hiện tại: </p>
                        <span id="hump-details" class="formatted-number"></span>
                        <p> %</p>
                    </div>
                </div>
                <p style="font-weight: bold;">Đọc lần cuối tại:</p>
                <span style="font-size: 36px;" id="Time-CH4"></span>
                <table id="tableCH4">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Giá trị</th>
                        </tr>
                    </thead>
                    <tbody id="dataBodyCH4">
                    </tbody>
                </table>
                <div class="detail">
                    <div class="text">
                        <p style="height: 24px;font-size: 24px;"><strong>Chỉ số Gas phòng 1</strong> <span
                                id="CH4-chart"></span>
                        </p>
                    </div>
                    <div class="chart">
                        <canvas id="canvasCH4"></canvas>
                    </div>
                </div>
            </div>
            <div id="LPG-details" class="tex-infor">
                <p style="font-weight: bold; font-size: 32px;">Phòng 2</p>
                <p style="font-weight: bold;">LPG:</p>
                <span style="font-size: 36px;" id="LPG"></span>
                <div id="stadard-info">
                    <div id="temp" class="tex-infor">
                        <img style="height: 40px; width: 26.3px;" src="./assets/image/R.png" alt="" srcset="">
                        <p>Nhiệt độ hiện tại: </p>
                        <span id="temp-details" class="formatted-number"></span>
                        <p> độ C</p>
                    </div>
                    <div id="hump" class="tex-infor">
                        <img style="height: 40px; width: 40px;" src="./assets/image/R.jpg" alt="" srcset="">
                        <p>Độ ẩm hiện tại: </p>
                        <span id="hump-details" class="formatted-number"></span>
                        <p> %</p>
                    </div>
                </div>
                <p style="font-weight: bold;">Đọc lần cuối tại:</p>
                <span style="font-size: 36px;" id="Time-LPG"></span>
                <table id="tableLPG">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Giá trị</th>
                        </tr>
                    </thead>
                    <tbody id="dataBodyLPG">
                    </tbody>
                </table>
                <div class="detail">
                    <div class="text">
                        <p style="height: 24px;font-size: 24px;"><strong>Chỉ số Gas phòng 2</strong> <span
                                id="LPG-chart"></span>
                        </p>
                    </div>
                    <div class="chart">
                        <canvas id="canvasLPG"></canvas>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>


        function changeWidth(myElement, newWidth) {
            myElement.style.width = newWidth + 'px';
        }
        let chartDataCH4 = [];
        let timedataCH4 = [];
        let chartDataLPG = [];
        let timedataLPG = [];

        async function fetchCommonData() {
            try {
                const response = await fetch('/api/data/fetchcommon');
                if (!response.ok) {
                    console.log('not ok');
                    throw new Error(`Failed to fetch data. Status: ${response.status}`);
                }
                const data = await response.json();

                let nhiet = data[0].Temp.toFixed(1);
                let am = data[0].Hump.toFixed(1);
                console.log(nhiet);
                document.getElementById("temp-details").innerHTML = nhiet;
                document.getElementById("hump-details").innerHTML = am;
                console.log(data[0].Temp);
            } catch (error) {
                console.error('Error fetching data:', error.message);
            }
        }

        // Fetch data every 500 milliseconds
        setInterval(() => { fetchCommonData() }, 5000);
        function convertData(entry) {
            const convertData = `${entry} ppm`;
            return convertData;
        }
        async function fetchDataCH4() {
            try {
                const response = await fetch('/api/data/fetchch4');
                if (!response.ok) {
                    console.log('not ok');
                    throw new Error(`Failed to fetch data. Status: ${response.status}`);
                }
                const data = await response.json();
                const dataBodyCH4 = document.getElementById('dataBodyCH4');

                // Clear existing rows
                dataBodyCH4.innerHTML = '';

                // Keep track of displayed rows
                let displayedRows = data.slice(-5);
                // document.getElementById("LPG").innerHTML = entry.humidity;
                document.getElementById("CH4").innerHTML = convertData(data[0].Value);
                // document.getElementById("Time-LPG").innerHTML = entry.timestamp
                document.getElementById("Time-CH4").innerHTML = data[0].Time;
                // console.log(entry.timestamp);

                displayedRows.forEach(entry => {

                    const row = document.createElement('tr');

                    const timeCell = document.createElement('td');
                    timeCell.textContent = entry.Time;

                    const ValueCell = document.createElement('td');
                    ValueCell.textContent = convertData(entry.Value);

                    row.appendChild(timeCell);
                    row.appendChild(ValueCell);
                    chartDataCH4.unshift(entry.Value);
                    timedataCH4.unshift(entry.Time);

                    // Nếu mảng có hơn 5 phần tử, loại bỏ phần tử cuối cùng
                    if (chartDataCH4.length > 5) {
                        chartDataCH4.pop();
                        timedataCH4.pop();
                    }

                    // Cập nhật biểu đồ
                    myChartCH4.data.datasets[0].data = chartDataCH4;
                    myChartCH4.data.labels = timedataCH4;
                    myChartCH4.update();
                    // Append new row to the top of the table
                    dataBodyCH4.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching data:', error.message);
            }
        }

        // Fetch data every 500 milliseconds
        setInterval(() => { fetchDataCH4() }, 5000);

        async function fetchDataLPG() {
            try {
                const response = await fetch('/api/data/fetchlpg');
                if (!response.ok) {
                    console.log('not ok');
                    throw new Error(`Failed to fetch data. Status: ${response.status}`);
                }
                const data = await response.json();
                const dataBodyLPG = document.getElementById('dataBodyLPG');

                // Clear existing rows
                dataBodyLPG.innerHTML = '';

                // Keep track of displayed rows
                let displayedRows = data.slice(-5);

                // document.getElementById("LPG").innerHTML = entry.humidity;
                document.getElementById("LPG").innerHTML = convertData(data[0].Value);
                // document.getElementById("Time-LPG").innerHTML = entry.timestamp
                document.getElementById("Time-LPG").innerHTML = data[0].Time;
                displayedRows.forEach(entry => {
                    const row = document.createElement('tr');

                    const timeCell = document.createElement('td');
                    timeCell.textContent = entry.Time;

                    const ValueCell = document.createElement('td');
                    ValueCell.textContent = convertData(entry.Value);

                    row.appendChild(timeCell);
                    row.appendChild(ValueCell);
                    chartDataLPG.unshift(entry.Value);
                    timedataLPG.unshift(entry.Time);

                    // Nếu mảng có hơn 5 phần tử, loại bỏ phần tử đầu tiên
                    if (chartDataLPG.length > 5) {
                        chartDataLPG.pop();
                        timedataLPG.pop();
                    }

                    myChartLPG.data.datasets[0].data = chartDataLPG;
                    myChartLPG.data.labels = timedataLPG
                    myChartLPG.update();
                    // Append new row to the top of the table
                    dataBodyLPG.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching data:', error.message);
            }
        }

        // Fetch data every 500 milliseconds
        setInterval(() => { fetchDataLPG() }, 5000);





        let myChartCH4 = new Chart('canvasCH4', {
            type: 'line',
            data: {
                labels: timedataCH4,
                datasets: [{
                    label: 'My Data',
                    data: chartDataCH4,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },

        });
        let myChartLPG = new Chart('canvasLPG', {
            type: 'line',
            data: {
                labels: timedataLPG,
                datasets: [{
                    label: 'My Data',
                    data: chartDataLPG,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },

        });
    </script>
</body>

</html>